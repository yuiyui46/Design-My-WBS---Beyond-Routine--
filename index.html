<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design My WBS - GitHub対応版 -</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Noto Sans JP for a softer font style -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* 柔らかな影付きタイトル用スタイル */
        .text-3d {
            font-size: 2rem;
            font-weight: 700;
            color: #4b5563; /* メインの文字色を濃いグレーに */
            text-shadow: 6px 6px 10px #b0b0b0; /* 影をより柔らかいグレーに */
            font-family: 'Noto Sans JP', sans-serif; /* フォントをNoto Sans JPに変更 */
            transition: transform 0.3s ease-in-out;
        }

        .text-3d:hover {
            transform: scale(1.02);
        }

        .subtitle-3d {
            font-size: 1.25rem; /* フォントサイズを大きく調整 */
            font-weight: 200; /* フォントの太さを調整 */
            color: #6b7280; /* サブタイトルを濃いグレーに */
            text-shadow: 6px 6px 10px #b0b0b0; /* 影をメインタイトルと同様に */
        }

        .gantt-row {
            display: flex;
            align-items: center; /* 垂直方向中央寄せ */
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
            position: relative;
        }

        .gantt-row:hover {
            background-color: #f9fafb;
        }

        .gantt-cell {
            padding: 1rem;
            display: flex;
            align-items: center; /* 垂直方向中央寄せ */
            height: 100%;
        }

        .gantt-bar-container {
            position: relative;
            padding: 1rem 0;
            flex-shrink: 0;
            display: flex;
            align-items: center; /* ガントバーを垂直方向中央寄せ */
        }

        .gantt-bar {
            position: absolute;
            height: 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }

        /* 期限別色分け */
        .color-expired {
            background-color: #d1d5db;
        }

        .color-1-month {
            background-color: #fca5a5;
        }

        .color-1-2-months {
            background-color: #fde68a;
        }

        .color-2-months-plus {
            background-color: #a7f3d0;
        }
        
        /* 期限なしバーの新しいスタイル */
        .color-no-deadline {
            background-color: #fdfceb; /* アイボリー色 */
        }


        /* モーダル背景 */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* ガントチャート本体のスクロールコンテナ - スクロールバーを非表示に */
        .gantt-scroll-container {
            overflow-x: auto;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .gantt-scroll-container::-webkit-scrollbar {
            display: none;
        }

        /* 固定スクロールバーコンテナ */
        .fixed-scrollbar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            overflow-x: scroll;
            z-index: 40;
            background-color: #f3f4f6;
            border-top: 1px solid #e5e7eb;
        }
        
        /* カスタムスクロールバーのスタイル */
        .fixed-scrollbar-container::-webkit-scrollbar {
            height: 12px;
        }
        .fixed-scrollbar-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .fixed-scrollbar-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .fixed-scrollbar-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 現在日のライン */
        .today-line {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background-color: rgba(2, 132, 199, 0.4); /* sky-500の薄い色 */
            z-index: 20;
        }

        /* ドラッグ＆ドロップ用スタイル */
        .draggable-category {
            cursor: grab;
        }

        .dragging {
            opacity: 0.5;
        }

        .drop-target-before,
        .drop-target-after {
            position: relative;
        }
        .drop-target-before::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #3b82f6; /* 青色 */
            animation: pulse 1s infinite;
        }
        .drop-target-after::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #3b82f6; /* 青色 */
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scaleX(0); }
            50% { transform: scaleX(1); }
            100% { transform: scaleX(0); }
        }

        /* チャート全体に広がる縦線 */
        .full-height-today-line {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background-color: rgba(2, 132, 199, 0.4);
            z-index: 30; /* タイムラインとタスクバーの上に表示 */
        }
        
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <!-- メインコンテナ -->
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col items-start">
            <h1 class="text-3d md:text-5xl font-extrabold text-gray-900 leading-tight">
                Design My WBS <span class="subtitle-3d">- Beyond Routine -</span>
            </h1>
            <!-- 「未来をデザインする」という副題のフォントをタスク名と同じにする -->
            <p id="subtitle" class="text-lg font-normal text-gray-500 mt-2 mb-8">未来をデザインする</p>
        </header>
        
        <!-- 日付表示 - 中央配置に変更 -->
        <div class="flex justify-center mb-8">
            <div class="flex flex-col items-center space-y-1">
                <div class="text-xs font-bold text-gray-600 uppercase tracking-widest">
                    今日は...
                </div>
                <div class="flex items-center space-x-2 md:space-x-4">
                     <div class="flex flex-col items-start space-y-0.5">
                        <span id="today-year" class="text-sm md:text-base font-semibold text-gray-500"></span>
                        <span id="today-month" class="text-xl md:text-2xl font-extrabold text-gray-700"></span>
                    </div>
                    <div class="text-3xl font-extrabold text-sky-600 leading-none mb-1">
                        ...
                    </div>
                    <div id="date-block" class="flex flex-col items-center justify-center p-3 rounded-xl shadow-md bg-white border border-gray-200">
                        <span id="today-day" class="text-2xl md:text-3xl font-black text-gray-900 leading-none"></span>
                        <span id="today-weekday" class="text-xs md:text-sm text-gray-500 font-semibold tracking-wide"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- タスク追加ボタン -->
        <div class="my-4 flex justify-end">
            <button id="addTaskBtn"
                class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">
                <i class="fas fa-plus mr-2"></i>タスクを追加
            </button>
        </div>

        <!-- ガントチャートの凡例 -->
        <div class="flex flex-wrap gap-4 mb-6 text-sm">
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-2 color-expired"></div>
                <span>期限切れ</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-2 color-1-month"></div>
                <span>1ヶ月以内</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-2 color-1-2-months"></div>
                <span>1ヶ月〜2ヶ月</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-2 color-2-months-plus"></div>
                <span>2ヶ月以上</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-2 color-no-deadline"></div>
                <span>期限なし</span>
            </div>
        </div>
        
        <!-- ローディングコンテナ -->
        <div id="loading-container" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 hidden">
            <div class="flex flex-col items-center space-y-4">
                <svg class="animate-spin h-10 w-10 text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-xl font-semibold text-gray-700">読み込み中...</span>
            </div>
        </div>

        <!-- ガントチャート本体 -->
        <div class="bg-white rounded-2xl shadow-xl flex flex-col">
            <!-- スクロールを制御する単一コンテナ -->
            <div id="gantt-scroll-container" class="gantt-scroll-container">
                <!-- ヘッダー（タスク名とタイムライン） -->
                <div class="flex flex-grow relative">
                    <div class="w-64 flex-shrink-0 border-r border-gray-200">
                        <div class="gantt-cell font-bold bg-gray-200 h-20"></div>
                    </div>
                    <div id="timeline-header" class="relative bg-gray-200 h-20"></div>
                </div>
                <!-- ガントチャート本体とタイムラインヘッダーの間の白い線 -->
                <div class="w-full h-1 bg-white"></div>
                <!-- タスク行のコンテナ -->
                <div id="gantt-chart-body" class="relative"></div>
            </div>
        </div>
    </div>
    
    <!-- 固定されたスクロールバー -->
    <div id="fixed-scrollbar-container" class="fixed-scrollbar-container">
        <div id="fixed-scrollbar-content" class="h-full"></div>
    </div>


    <!-- モーダル（タスク追加・編集） -->
    <div id="taskModal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity modal-overlay hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg transition-transform transform scale-95 duration-300">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">タスクを追加</h2>
            <form id="taskForm" class="space-y-4">
                <div>
                    <label for="taskName" class="block text-gray-700 font-bold mb-1">タスク名</label>
                    <input type="text" id="taskName" name="taskName" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                 <div>
                    <label for="category" class="block text-gray-700 font-bold mb-1">カテゴリ</label>
                    <input type="text" id="category" name="category" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="startDate" class="block text-gray-700 font-bold mb-1">開始日</label>
                        <input type="date" id="startDate" name="startDate"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div class="w-1/2">
                        <label for="endDate" class="block text-gray-700 font-bold mb-1">終了日（期限）</label>
                        <input type="date" id="endDate" name="endDate"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                </div>
                <input type="hidden" id="taskId">
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="deleteTaskBtn"
                        class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105"
                        style="display: none;">
                        <i class="fas fa-trash-alt mr-2"></i>削除
                    </button>
                    <button type="button" id="closeModalBtn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">
                        キャンセル
                    </button>
                    <button type="submit"
                        class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="confirmModal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity modal-overlay hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md transition-transform transform scale-95 duration-300">
            <h2 class="text-xl font-bold mb-4">タスクの削除</h2>
            <p class="mb-6">このタスクを完全に削除してもよろしいですか？</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelDeleteBtn"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">
                    キャンセル
                </button>
                <button id="confirmDeleteBtn"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">
                    削除
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, deleteDoc, serverTimestamp, addDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ここにFirebaseコンソールから取得した設定情報を貼り付けてください
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = firebaseConfig.appId;
        
        let app;
        let db;
        let auth;
        let userId = null;
        let isSyncing = false;
        
        // UI要素
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskModal = document.getElementById('taskModal');
        const confirmModal = document.getElementById('confirmModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const taskForm = document.getElementById('taskForm');
        const modalTitle = document.getElementById('modalTitle');
        const deleteTaskBtn = document.getElementById('deleteTaskBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        // 日付表示用の新しい要素
        const todayDayElement = document.getElementById('today-day');
        const todayWeekdayElement = document.getElementById('today-weekday');
        const todayMonthElement = document.getElementById('today-month');
        const todayYearElement = document.getElementById('today-year');

        const timelineHeader = document.getElementById('timeline-header');
        const ganttChartBody = document.getElementById('gantt-chart-body');
        const ganttScrollContainer = document.getElementById('gantt-scroll-container');
        const loadingContainer = document.getElementById('loading-container');
        const fixedScrollbarContainer = document.getElementById('fixed-scrollbar-container');
        const fixedScrollbarContent = document.getElementById('fixed-scrollbar-content');

        const pixelsPerDay = 3.5; // 1/4縮尺を維持
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const todayLine = document.createElement('div');
        todayLine.className = 'full-height-today-line';
        todayLine.id = 'today-line';

        let dragSrcCategoryRow = null;

        // タスク初期データ
        const initialTasks = [{
            taskName: "キャリアコンサルタント 試験準備",
            category: "起業関連",
            startDate: "2025-09-01",
            endDate: null
        }, {
            taskName: "社労士 試験準備",
            category: "起業関連",
            startDate: "2025-09-01",
            endDate: null
        }, {
            taskName: "東京都の創業支援事業登録",
            category: "起業関連",
            startDate: null,
            endDate: "2026-04-01"
        }, {
            taskName: "シェアオフィス登録",
            category: "起業関連",
            startDate: null,
            endDate: "2025-09-30"
        }, {
            taskName: "博士論文中間審査",
            category: "博士課程",
            startDate: "2026-01-20",
            endDate: "2026-01-21"
        }, {
            taskName: "日本がん検診・診断学会 発表",
            category: "学会発表",
            startDate: "2025-09-17",
            endDate: "2025-09-18"
        }, {
            taskName: "日本公衆衛生学会 発表",
            category: "学会発表",
            startDate: "2025-10-29",
            endDate: "2025-10-31"
        }, {
            taskName: "日本乳癌検診学会 発表",
            category: "学会発表",
            startDate: "2025-11-28",
            endDate: "2025-11-29"
        }, {
            taskName: "日本産業衛生学会（論文査読対応）",
            category: "論文投稿",
            startDate: "2025-09-01",
            endDate: null
        }, {
            taskName: "日本がん検診・診断学会（論文投稿）",
            category: "論文投稿",
            startDate: null,
            endDate: "2025-09-30"
        }, {
            taskName: "日本産業衛生学会または総合健診学会 論文投稿",
            category: "論文投稿",
            startDate: null,
            endDate: "2026-03-31"
        }, {
            taskName: "TM社 健康だより作成",
            category: "その他",
            startDate: null,
            endDate: "2025-09-30"
        }, {
            taskName: "TM社 運動会講話資料作成",
            category: "その他",
            startDate: null,
            endDate: "2025-10-15"
        }, {
            taskName: "TM社 親子イベント講話資料作成",
            category: "その他",
            startDate: null,
            endDate: "2025-11-01"
        }, ];

        // アプリケーション初期化
        window.onload = async () => {
            try {
                loadingContainer.classList.remove('hidden');
                
                // Firebase設定が未入力の場合の処理
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    ganttChartBody.innerHTML = `<div class="p-4 text-center text-red-500 font-bold">
                        Firebase設定が未入力です。データの永続化機能は無効です。
                        <p class="mt-2 text-sm text-gray-500">
                            このコードの &lt;script&gt; タグ内にある ` + "`firebaseConfig`" + ` オブジェクトに、
                            ご自身のFirebaseプロジェクトの設定情報を貼り付けてください。
                        </p>
                    </div>`;
                    loadingContainer.classList.add('hidden');
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 匿名認証でサインイン
                signInAnonymously(auth).catch((error) => {
                    console.error("匿名認証エラー:", error);
                    ganttChartBody.innerHTML = `<div class="p-4 text-center text-red-500 font-bold">認証に失敗しました。</div>`;
                    loadingContainer.classList.add('hidden');
                });
                
                // 認証状態の監視
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("ユーザーID:", userId);
                        
                        // 初回ロード時にデータが存在しない場合、初期データをFirestoreに追加
                        // 注意: ユーザーごとのプライベートなパスを使用します
                        const tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/wbs_tasks`);
                        const snapshot = await getDocs(tasksCollectionRef);
                        if (snapshot.empty) {
                            for (const task of initialTasks) {
                                await addDoc(tasksCollectionRef, task);
                            }
                            console.log("初期データをFirestoreに追加しました。");
                        }
                        // リアルタイムリスナーを開始
                        startRealtimeListener();
                    } else {
                        userId = crypto.randomUUID();
                        console.log("ユーザーが認証されていません。匿名ユーザーとして続行します。");
                        ganttChartBody.innerHTML = `<div class="p-4 text-center text-red-500 font-bold">データをロードできませんでした。</div>`;
                        loadingContainer.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Firebaseの初期化に失敗しました。", error);
                loadingContainer.classList.add('hidden');
            }
        };

        // リアルタイムリスナー
        function startRealtimeListener() {
            // 注意: ユーザーごとのプライベートなパスを使用します
            const tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/wbs_tasks`);
            const categoryOrderRef = doc(db, `artifacts/${appId}/users/${userId}/config/categoryOrder`);

            onSnapshot(tasksCollectionRef, (tasksSnapshot) => {
                const tasks = tasksSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // カテゴリ順序をFirestoreから取得
                onSnapshot(categoryOrderRef, (orderDoc) => {
                    const order = orderDoc.exists() ? orderDoc.data().order : [];
                    renderGanttChart(tasks, order);
                    loadingContainer.classList.add('hidden');
                }, (error) => {
                    console.error("カテゴリ順序の取得中にエラーが発生しました:", error);
                    loadingContainer.classList.add('hidden');
                });
            }, (error) => {
                console.error("タスクの取得中にエラーが発生しました:", error);
                ganttChartBody.innerHTML = `<div class="p-4 text-center text-red-500 font-bold">データの取得に失敗しました。</div>`;
                loadingContainer.classList.add('hidden');
            });

            // スクロールイベントリスナーをセットアップ
            ganttScrollContainer.addEventListener('scroll', () => {
                if (!isSyncing) {
                    isSyncing = true;
                    fixedScrollbarContainer.scrollLeft = ganttScrollContainer.scrollLeft;
                    isSyncing = false;
                }
            });
            fixedScrollbarContainer.addEventListener('scroll', () => {
                if (!isSyncing) {
                    isSyncing = true;
                    ganttScrollContainer.scrollLeft = fixedScrollbarContainer.scrollLeft;
                    isSyncing = false;
                }
            });
        }

        // カテゴリの並べ替え順序をFirestoreに保存
        async function saveCategoryOrder(order) {
            // 注意: ユーザーごとのプライベートなパスを使用します
            const categoryOrderRef = doc(db, `artifacts/${appId}/users/${userId}/config/categoryOrder`);
            try {
                await setDoc(categoryOrderRef, { order });
                console.log("カテゴリの順序を保存しました。");
            } catch (error) {
                console.error("カテゴリの順序の保存に失敗しました:", error);
            }
        }

        /**
         * ガントチャートを描画する関数
         * @param {Array<Object>} tasks
         * @param {Array<string>} order
         */
        function renderGanttChart(tasks, order) {
            // 現在日の表示を更新
            const now = new Date();
            todayDayElement.textContent = now.getDate();
            todayWeekdayElement.textContent = now.toLocaleDateString('ja-JP', { weekday: 'long' });
            todayMonthElement.textContent = `${now.getMonth() + 1}月`;
            todayYearElement.textContent = `${now.getFullYear()}年`;

            // カテゴリ別にグループ化し、各グループ内を期限でソート
            const tasksByCategory = tasks.reduce((acc, task) => {
                const category = task.endDate ? task.category : '期限なし';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(task);
                return acc;
            }, {});

            // カテゴリのキーを取得
            let categories = Object.keys(tasksByCategory);

            // 並べ替え順序が存在すれば適用
            const allCategories = [...new Set([...categories, ...order])];
            const sortedCategories = allCategories.sort((a, b) => {
                const indexA = order.indexOf(a);
                const indexB = order.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            }).filter(c => categories.includes(c));

            // タイムラインの表示期間を設定
            const minDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
            const maxDate = new Date(today.getFullYear() + 1, today.getMonth() + 9, 1); // 今から1年間+α

            timelineHeader.innerHTML = '';
            ganttChartBody.innerHTML = '';
            
            const daysInView = (maxDate - minDate) / (1000 * 60 * 60 * 24);
            const totalTimelineWidth = Math.max(800, daysInView * pixelsPerDay); 
            
            // ガントチャートの幅をタイムラインに合わせる
            timelineHeader.style.width = `${totalTimelineWidth}px`;
            fixedScrollbarContent.style.width = `${totalTimelineWidth}px`;
            
            let currentDate = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
            while (currentDate <= maxDate) {
                const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                const monthStartOffsetDays = (currentDate - minDate) / (1000 * 60 * 60 * 24);
                const monthDurationDays = (nextMonth - currentDate) / (1000 * 60 * 60 * 24);
                
                const monthStartPx = monthStartOffsetDays * pixelsPerDay;
                const monthWidthPx = monthDurationDays * pixelsPerDay;

                const monthHeader = document.createElement('div');
                monthHeader.className = `absolute h-full bg-gray-200`; // すべての月の背景色を統一

                monthHeader.style.left = `${monthStartPx}px`;
                monthHeader.style.width = `${monthWidthPx}px`;

                const monthGrid = document.createElement('div');
                monthGrid.className = 'absolute h-full w-0.5 bg-gray-300 left-0 top-0';
                monthHeader.appendChild(monthGrid);

                monthHeader.innerHTML += `
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-sm font-semibold text-gray-700">
                        ${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月
                    </div>
                `;
                timelineHeader.appendChild(monthHeader);
                currentDate = nextMonth;
            }

            // 現在日のラインを追加
            const todayOffsetDays = (today - minDate) / (1000 * 60 * 60 * 24);
            const todayPx = todayOffsetDays * pixelsPerDay;
            todayLine.style.left = `${todayPx}px`;
            timelineHeader.appendChild(todayLine);

            sortedCategories.forEach(category => {
                // カテゴリ見出し行を追加 - レイアウトを修正
                const categoryHeaderRow = document.createElement('div');
                categoryHeaderRow.className = 'flex items-center bg-gray-200 text-gray-700 font-bold draggable-category';
                categoryHeaderRow.setAttribute('data-category', category);
                categoryHeaderRow.setAttribute('draggable', true);
                // タイムライン全体に背景が広がるように、幅を設定
                categoryHeaderRow.style.width = `calc(16rem + ${totalTimelineWidth}px)`;
                
                categoryHeaderRow.innerHTML = `
                    <div class="gantt-cell text-sm w-64 flex-shrink-0">
                        <i class="fas fa-grip-vertical mr-2 cursor-grab"></i>
                        ${category}
                    </div>
                    <div class="flex-grow p-4" style="width: ${totalTimelineWidth}px;"></div>
                `;
                ganttChartBody.appendChild(categoryHeaderRow);

                // 各カテゴリ内のタスクを期限でソート
                const sortedTasksInCategory = tasksByCategory[category].sort((a, b) => {
                    const dateA = a.endDate ? new Date(a.endDate) : new Date(8640000000000000);
                    const dateB = b.endDate ? new Date(b.endDate) : new Date(8640000000000000);
                    return dateA - dateB;
                });

                sortedTasksInCategory.forEach(task => {
                    const ganttRow = document.createElement('div');
                    ganttRow.className = 'gantt-row';

                    // ガントチャートの幅に合わせてタスク行の幅を設定する
                    ganttRow.style.width = `calc(16rem + ${totalTimelineWidth}px)`;

                    // タスク名表示
                    const taskNameCell = document.createElement('div');
                    taskNameCell.className = 'gantt-cell text-sm w-64 flex-shrink-0';
                    taskNameCell.innerHTML = `<span class="truncate font-medium">${task.taskName}</span>`;

                    const ganttBarContainer = document.createElement('div');
                    ganttBarContainer.className = 'gantt-bar-container';
                    ganttBarContainer.style.width = `${totalTimelineWidth}px`;

                    let bar;
                    let leftPx = 0;
                    let widthPx = 0;
                    let colorClass = '';
                    
                    if (task.endDate) {
                        // 終了日がある場合
                        const taskEndDate = new Date(task.endDate);
                        const daysUntilDeadline = (taskEndDate - today) / (1000 * 60 * 60 * 24);
                        
                        // 開始日の設定
                        const taskStartDate = task.startDate ? new Date(task.startDate) : today;
                        leftPx = (taskStartDate - minDate) / (1000 * 60 * 60 * 24) * pixelsPerDay;
                        widthPx = (taskEndDate - taskStartDate) / (1000 * 60 * 60 * 24) * pixelsPerDay;

                        if (daysUntilDeadline < 0) {
                            colorClass = 'color-expired';
                        } else if (daysUntilDeadline <= 30) {
                            colorClass = 'color-1-month';
                        } else if (daysUntilDeadline <= 60) {
                            colorClass = 'color-1-2-months';
                        } else {
                            colorClass = 'color-2-months-plus';
                        }
                    } else { // 期限なしの場合
                        const taskStartDate = task.startDate ? new Date(task.startDate) : minDate;
                        leftPx = (taskStartDate - minDate) / (1000 * 60 * 60 * 24) * pixelsPerDay;
                        widthPx = (maxDate - taskStartDate) / (1000 * 60 * 60 * 24) * pixelsPerDay;
                        colorClass = 'color-no-deadline';
                    }
                    
                    if (widthPx > 0) {
                        bar = document.createElement('div');
                        bar.className = `gantt-bar ${colorClass}`;
                        bar.style.left = `${leftPx}px`;
                        bar.style.width = `${widthPx}px`;
                        bar.title = `${task.taskName}\n開始日: ${task.startDate || '未定'}\n期限: ${task.endDate || '未定'}`;
                        bar.onclick = () => showModal(task);
                        ganttBarContainer.appendChild(bar);
                    }
                    
                    ganttRow.appendChild(taskNameCell);
                    ganttRow.appendChild(ganttBarContainer);
                    ganttChartBody.appendChild(ganttRow);
                });
            });


            // 現在日の位置に自動でスクロール
            setTimeout(() => {
                const nowOffsetDays = (today - minDate) / (1000 * 60 * 60 * 24);
                const nowPx = nowOffsetDays * pixelsPerDay;
                const scrollLeft = Math.max(0, nowPx - (ganttScrollContainer.offsetWidth / 2));
                ganttScrollContainer.scrollLeft = scrollLeft;
                fixedScrollbarContainer.scrollLeft = scrollLeft;
            }, 100);

            // ドラッグ＆ドロップイベントリスナーを登録
            addDragDropListeners();
        }

        // モーダル表示
        function showModal(task = null) {
            taskModal.classList.remove('hidden');
            taskModal.classList.add('flex', 'opacity-100');
            modalTitle.textContent = task ? 'タスクを編集' : 'タスクを追加';
            deleteTaskBtn.style.display = task ? 'inline-block' : 'none';

            if (task) {
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.taskName;
                document.getElementById('category').value = task.category || '';
                document.getElementById('startDate').value = task.startDate || '';
                document.getElementById('endDate').value = task.endDate || '';
            } else {
                taskForm.reset();
                document.getElementById('taskId').value = '';
            }
        }

        // モーダル非表示
        function hideModal() {
            taskModal.classList.remove('opacity-100');
            taskModal.classList.add('hidden');
            taskForm.reset();
        }

        // 確認モーダル表示
        function showConfirmModal() {
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex', 'opacity-100');
        }

        // 確認モーダル非表示
        function hideConfirmModal() {
            confirmModal.classList.remove('opacity-100');
            confirmModal.classList.add('hidden');
        }

        // イベントリスナー
        addTaskBtn.addEventListener('click', () => showModal());
        closeModalBtn.addEventListener('click', hideModal);
        taskModal.addEventListener('click', (e) => {
            if (e.target.id === 'taskModal') {
                hideModal();
            }
        });

        // フォーム送信処理
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskId = document.getElementById('taskId').value;
            const taskData = {
                taskName: document.getElementById('taskName').value,
                category: document.getElementById('category').value || null,
                startDate: document.getElementById('startDate').value || null,
                endDate: document.getElementById('endDate').value || null,
                updatedAt: serverTimestamp()
            };

            // 注意: ユーザーごとのプライベートなパスを使用します
            const tasksCollection = collection(db, `artifacts/${appId}/users/${userId}/wbs_tasks`);

            try {
                if (taskId) {
                    await setDoc(doc(tasksCollection, taskId), taskData, {
                        merge: true
                    });
                    console.log("タスクを更新しました。");
                } else {
                    await addDoc(tasksCollection, {
                        ...taskData,
                        createdAt: serverTimestamp()
                    });
                    console.log("タスクを追加しました。");
                }
                hideModal();
            } catch (error) {
                console.error("データの保存に失敗しました:", error);
            }
        });

        // タスク削除ボタンクリック
        deleteTaskBtn.addEventListener('click', () => {
            showConfirmModal();
        });

        // 削除確認ボタンクリック
        confirmDeleteBtn.addEventListener('click', async () => {
            const taskId = document.getElementById('taskId').value;
            // 注意: ユーザーごとのプライベートなパスを使用します
            const tasksCollection = collection(db, `artifacts/${appId}/users/${userId}/wbs_tasks`);
            try {
                await deleteDoc(doc(tasksCollection, taskId));
                console.log("タスクを削除しました。");
                hideConfirmModal();
                hideModal();
            } catch (error) {
                console.error("タスクの削除に失敗しました:", error);
            }
        });

        // 削除キャンセルボタンクリック
        cancelDeleteBtn.addEventListener('click', hideConfirmModal);
        confirmModal.addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') {
                hideConfirmModal();
            }
        });

        // ドラッグ＆ドロップ関連
        function addDragDropListeners() {
            const categories = document.querySelectorAll('.draggable-category');
            categories.forEach(category => {
                category.addEventListener('dragstart', handleDragStart);
                category.addEventListener('dragover', handleDragOver);
                category.addEventListener('dragleave', handleDragLeave);
                category.addEventListener('drop', handleDrop);
                category.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcCategoryRow = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.getAttribute('data-category'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const categoryRow = this;

            // ドラッグ中の要素が自身の場合は何もしない
            if (categoryRow === dragSrcCategoryRow) {
                return;
            }

            const bounding = categoryRow.getBoundingClientRect();
            const offset = bounding.y + (bounding.height / 2);
            const isAfter = e.clientY > offset;
            
            // ドロップインジケーターを更新
            document.querySelectorAll('.drop-target-before, .drop-target-after').forEach(el => {
                el.classList.remove('drop-target-before', 'drop-target-after');
            });
            if (isAfter) {
                categoryRow.classList.add('drop-target-after');
            } else {
                categoryRow.classList.add('drop-target-before');
            }
        }

        function handleDragLeave() {
            this.classList.remove('drop-target-before', 'drop-target-after');
        }

        function handleDrop(e) {
            e.preventDefault();
            const draggedCategory = e.dataTransfer.getData('text/plain');
            const dropTargetCategory = this.getAttribute('data-category');

            if (draggedCategory !== dropTargetCategory) {
                const isAfter = this.classList.contains('drop-target-after');
                
                // 現在のカテゴリ順序を取得
                const currentOrder = Array.from(ganttChartBody.querySelectorAll('.draggable-category'))
                    .map(el => el.getAttribute('data-category'));

                // 新しい順序を計算
                const newOrder = currentOrder.filter(c => c !== draggedCategory);
                const dropIndex = newOrder.indexOf(dropTargetCategory);
                const insertIndex = isAfter ? dropIndex + 1 : dropIndex;

                newOrder.splice(insertIndex, 0, draggedCategory);
                
                // Firestoreに新しい順序を保存
                saveCategoryOrder(newOrder);

                // UIを再描画
                // Firestoreリスナーが自動的に再描画を行うため、ここでは何もしなくても良い
                // もしリアルタイムではない場合は、renderGanttChart(tasks, newOrder); を呼び出す
            }

            this.classList.remove('drop-target-before', 'drop-target-after');
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.drop-target-before, .drop-target-after').forEach(el => {
                el.classList.remove('drop-target-before', 'drop-target-after');
            });
        }
    </script>
</body>
</html>
